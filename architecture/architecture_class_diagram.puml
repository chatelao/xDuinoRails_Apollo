@startuml
!option handwritten true

title System Class Diagram

class xdrTrainAPI {
  - config: LocoFuncDecoderConfig
  - cvManager: "CV Manager"
  - lights: Lights
  - sounds: Sounds*
  - motors: Motors*
  + begin(config)
  + update()
  + getLights(): Lights&
  + getCVManager(): "CV Manager"&
  + getMotors(): Motors*
  + handleDccSpeed(...)
  - handleDccFunc(...)
  - handleCVChange(...)
}

class "CV Manager" {
  - _cv_values: map<uint16_t, uint8_t>
  + begin()
  + readCV(cv_number): uint8_t
  + writeCV(cv_number, value)
  + loadCVsFromEeprom()
  + writeCvToEeprom(...)
}

class Lights {
  - _outputs: vector<PhysicalOutput>
  - _logical_functions: vector<LogicalFunction*>
  - _mapping_rules: vector<MappingRule>
  - _function_states: bool[]
  - _direction: DecoderDirection
  - _speed: uint16_t
  + addPhysicalOutput(pin, type)
  + update(delta_ms)
  + loadFromCVs(cvAccess)
  + setFunctionState(func, state)
  + setDirection(direction)
  + setSpeed(speed)
}

class Sounds {
  - _driver: SoundDriver*
  + begin(): bool
  + play(track)
  + setVolume(volume)
  + loop()
  + write(data, size): size_t
}

class Motors {
  - pImpl: XDuinoRails_MotorDriver_Impl*
  + begin()
  + update()
  + setTargetSpeed(speed)
  + setDirection(forward)
  + enablePIController(enable)
  + setPIgains(kp, ki)
  + setAcceleration(rate)
  + setDeceleration(rate)
}

class Effects {
}

xdrTrainAPI o-- "CV Manager"
xdrTrainAPI o-- Lights
xdrTrainAPI o-- Sounds
xdrTrainAPI o-- Motors
xdrTrainAPI o-- Effects

@enduml
